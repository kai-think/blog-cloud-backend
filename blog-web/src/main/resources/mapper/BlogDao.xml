<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xb.blog.web.dao.BlogDao">
    <select id="listBlog" resultType="com.xb.blog.web.vo.BlogListVo">
        SELECT
            b.uid,
            b.title,
            b.summary,
            b.pic_uid picUid,
            IFNULL(b.click_count, 0) clickCount,
            IFNULL(b.like_count, 0) likeCount,
            IFNULL(b.collect_count, 0) collectCount,
            u.uid authorId,
            u.nick_name authorName
        FROM
            t_blog b
                LEFT JOIN t_user u ON b.author = u.uid
        WHERE
            b.status = 1
        ORDER BY
            b.create_time DESC
    </select>
    <select id="getBlogPreviewById" parameterType="String" resultType="com.xb.blog.web.vo.BlogPreviewVo">
        SELECT
            b.uid,
            b.title,
            b.content,
            IFNULL(b.click_count, 0) clickCount,
            IFNULL(b.like_count, 0) likeCount,
            IFNULL(b.comment_count, 0) commentCount,
            IFNULL(b.collect_count, 0) collectCount,
            u.uid authorId,
            u.nick_name authorName,
            b.create_time createTime,
            CASE WHEN l.uid IS NOT NULL THEN 1 ELSE 0 END liked
        FROM
            t_blog b
                LEFT JOIN t_user u ON b.author = u.uid
                LEFT JOIN t_like l ON l.type = 1 AND b.uid = l.obj_uid AND l.user_uid = #{userUid}
        WHERE
            b.status = 1 AND b.uid = #{uid}
    </select>
    <update id="updateLikeCount">
        update t_blog set like_count = COALESCE(like_count, 0) + #{count} where uid = #{blogId}
    </update>
    <select id="getLikeCountByBlogId" parameterType="String" resultType="Long">
        select like_count from t_blog where uid = #{blogId}
    </select>
    <update id="updateCommentCount">
        update t_blog set comment_count = COALESCE(comment_count, 0) + #{count} where uid = #{blogId}
    </update>
    <select id="getCommentCountByBlogId" parameterType="String" resultType="Long">
        select COALESCE(comment_count, 0) from t_blog where uid = #{blogId}
    </select>
</mapper>